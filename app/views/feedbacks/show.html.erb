<% content_for :title, "Feedback ##{@feedback.id}" %>

<% content_for :page_header do %>
  <%# Breadcrumb navigation for context %>
  <div class="flex items-center gap-half text-sm">
    <%= link_to "User Feedbacks", feedbacks_path, class: "text-subtle hover:text-primary" %>
    <span class="text-subtle">/</span>
    <span class="text-primary">Feedback ##<%= @feedback.id %></span>
  </div>
<% end %>

<div class="i-full p-4 mi-auto" style="max-width: 90rem;">
  
  <%# --- Page Header with Actions --- %>
  <div class="flex justify-between items-center mbe-4">
    <div>
      <h1 class="font-bold text-2xl">Feedback Details</h1>
      <p class="text-subtle text-sm">Submitted by <%= @feedback.user.name || @feedback.user.email %> on <%= @feedback.created_at.strftime("%B %-d, %Y") %></p>
    </div>

    <div class="flex items-center gap">
      <%= link_to "Edit", edit_feedback_path(@feedback), class: "btn", data: { turbo_frame: "modal" } %>
      
      <% delete_trigger = button_tag "Delete", type: "button", class: "btn btn--negative", data: { action: "dialog#showModal" } %>
      <%= modal_dialog delete_trigger, title: "Delete feedback?" do %>
        <p class="text-sm text-subtle mbe-4">This action cannot be undone. All data will be permanently lost.</p>
        
        <%= render partial: "feedbacks/delete_summary", locals: { feedback: @feedback } %>

        <div class="flex items-center justify-end gap">
          <button type="button" class="btn" data-action="click->dialog#close">Cancel</button>
          <%= button_to "Continue", @feedback, method: :delete, class: "btn btn--negative", form: { data: { action: "turbo:submit-end->dialog#close" } } %>
        </div>
      <% end %>
    </div>
  </div>

  <%# --- Main Content Grid (Corrected) --- %>
  <div class="grid grid-cols-1 grid-cols-3@lg gap-4">
    
    <%# --- Left Column: Full Comment --- %>
    <%# CORRECTED: Using the "col-span-2" class from your CSS file %>
    <div class="p-4 bg-surface border border-main rounded-lg shadow-sm col-span-2">
      <h3 class="font-semibold mbe-2">Full Comment</h3>
      <div class="prose">
        <%= simple_format(@feedback.comment, class: "text-primary leading-tight") %>
      </div>
    </div>

    <%# --- Right Column: Metadata Sidebar --- %>
    <div class="flex flex-col gap-4">
      
      <%# Details Card %>
      <div class="p-4 bg-surface border border-main rounded-lg shadow-sm">
        <h3 class="font-semibold mbe-3">Details</h3>
        <dl class="flex flex-col gap-2 text-sm">
          <div class="flex justify-between items-center">
            <dt class="text-subtle">Type</dt>
            <dd><span class="<%= feedback_badge_classes(@feedback.feedback_type) %>"><%= @feedback.feedback_type.humanize %></span></dd>
          </div>
          <div class="flex justify-between items-center">
            <dt class="text-subtle">Service</dt>
            <dd class="font-medium text-primary"><%= @feedback.service.humanize %></dd>
          </div>
          <% if @feedback.rating.present? %>
            <div class="flex justify-between items-center">
              <dt class="text-subtle">Rating</dt>
              <dd class="flex items-center gap-half">
                <% @feedback.rating.times do %>
                  <svg style="inline-size: 1rem; block-size: 1rem;" fill="var(--amber-400)" viewBox="0 0 22 20"><path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.455 8.52l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.545 8.52a1.523 1.523 0 0 0 .379-.895Z"/></svg>
                <% end %>
                 <% (5 - @feedback.rating).times do %>
                  <svg style="inline-size: 1rem; block-size: 1rem;" fill="var(--slate-300)" viewBox="0 0 22 20"><path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.455 8.52l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.545 8.52a1.523 1.523 0 0 0 .379-.895Z"/></svg>
                <% end %>
              </dd>
            </div>
          <% end %>
          <div class="flex justify-between items-center">
            <dt class="text-subtle">Submitted At</dt>
            <dd class="text-primary"><%= @feedback.created_at.strftime("%-d %b %Y, %I:%M %p") %></dd>
          </div>
        </dl>
      </div>

      <%# Linked Audio Clip Card (Conditional) %>
      <% if @feedback.generated_audio_clip %>
        <% audio = @feedback.generated_audio_clip %>
        <div class="p-4 bg-surface border border-main rounded-lg shadow-sm">
          <h3 class="font-semibold mbe-3">Linked Audio Clip</h3>
          <div class="flex justify-between items-center">
            <div class="flex flex-col gap-half text-sm min-i-0">
              <p class="text-subtle overflow-ellipsis">"<%= audio.text.truncate(40) %>"</p>
              <span class="font-medium text-primary"><%= audio.voice&.name || 'N/A' %></span>
            </div>
            <% if audio.s3_key.present? %>
              <button type="button" class="btn btn--icon btn--subtle shrink-0"
                      data-action="click->audio-fetcher#fetch"
                      data-audio-fetcher-url-param="<%= audio_url_generated_audio_clip_path(audio) %>"
                      data-audio-fetcher-title-param="<%= audio.text.truncate(40) %>"
                      data-audio-fetcher-author-param="<%= audio.voice&.name || 'N/A' %>">
                <div data-play-icon-url>
                  <svg fill="currentColor" width="15" height="15" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                </div>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>