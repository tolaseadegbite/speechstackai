<%# Set a default context if one wasn't passed %>
<% context ||= :history %>

<%= tag.div class: "flex justify-between items-center voice-list-item text-start p-2 border-be",
            id: dom_id(text_to_speech_clip, context) do %>

  <% case text_to_speech_clip.status %>
  <% when "pending", "processing" %>
    <div class="flex flex-col gap-half text-sm">
      <h4 class="overflow-ellipsis font-semibold text-subtle">
        <%= text_to_speech_clip.text.truncate(40) %> 
        (<%= text_to_speech_clip.status.humanize %>...)
      </h4>
      <div class="flex items-center gap-2 text-sm text-subtle">
        <span class="voice-swatch shrink-0" 
              style="--icon-size: 1.5rem; <%= voice_gradient_style(text_to_speech_clip.voice) %>" 
              aria-hidden="true"></span>
        <span><%= text_to_speech_clip.voice.name %> 路 <%= text_to_speech_clip.created_at.strftime('%I:%M %p') %></span>
      </div>
    </div>
    <div class="flex items-center gap-2 shrink-0 mis-2">
      <div class="btn btn--icon btn--subtle" aria-label="Processing">
        <span class="icon icon--loading animate-spin" aria-hidden="true"></span>
      </div>
    </div>

  <% when "failed", "no_credits" %>
    <div class="flex flex-col gap-half text-sm flex-grow min-w-0">
      <h4 class="overflow-ellipsis font-semibold text-red-500"><%= text_to_speech_clip.text.truncate(40) %></h4>
      <div class="flex items-center gap-2 text-sm text-subtle">
        <span class="voice-swatch shrink-0" 
              style="--icon-size: 1.5rem; <%= voice_gradient_style(text_to_speech_clip.voice) %>" 
              aria-hidden="true"></span>
        <span><%= text_to_speech_clip.voice.name %> 路 <%= text_to_speech_clip.created_at.strftime('%I:%M %p') %></span>
      </div>
      <div class="flex items-center gap-2 text-sm text-red-500">
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        <span><%= text_to_speech_clip.failed? ? "Generation failed" : "Insufficient credits" %> 路 <%= text_to_speech_clip.created_at.strftime('%I:%M %p') %></span>
      </div>
    </div>
    <div class="flex items-center gap-2 shrink-0 mis-2">
      <% trigger = button_tag type: "button", class: "btn btn--icon btn--subtle", data: { action: "dialog#showModal" } do %>
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      <% end %>
      <%= modal_dialog trigger, title: "Delete this audio clip?" do %>
        <p class="text-sm text-subtle mbe-4">This will permanently delete this audio clip. This action cannot be undone.</p>
        <div class="flex items-center justify-end gap">
          <button type="button" class="btn" data-action="click->dialog#close">Cancel</button>
          <%= link_to "Continue", 
                generated_audio_clip_path(text_to_speech_clip, context: context), 
                data: { turbo_method: :delete }, 
                class: "btn btn--negative" %>
        </div>
      <% end %>
    </div>

  <% when "processed" %>
    <div class="flex flex-col gap-half text-sm">
      <div contents data-controller="popover" data-action="mouseenter->popover#debouncedShow mouseleave->popover#debouncedHide" data-popover-placement-value="bottom-right">
        <a href="" class="" data-popover-target="trigger">
          <h4 class="overflow-ellipsis font-semibold"><%= text_to_speech_clip.text.truncate(40) %></h4>
        </a>
        <div popover="hint" class="popover shadow-md max-b-screen-32" style="max-width: 20rem;" data-popover-target="content" role="dialog">
          <div class="flex flex-col p-4"><p class="text-sm text-subtle"><%= text_to_speech_clip.text %></p></div>
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm text-subtle">
        <span class="voice-swatch shrink-0" 
              style="--icon-size: 1.5rem; <%= voice_gradient_style(text_to_speech_clip.voice) %>" 
              aria-hidden="true"></span>
        <span><%= text_to_speech_clip.voice.name %> 路 <%= text_to_speech_clip.created_at.strftime('%I:%M %p') %></span>
      </div>
    </div>

    <div class="flex items-center gap-2 shrink-0 mis-2">

      <button type="button" class="btn btn--icon btn--subtle"
              data-action="click->audio-fetcher#fetch"
              data-audio-fetcher-url-param="<%= audio_url_generated_audio_clip_path(text_to_speech_clip) %>"
              data-audio-fetcher-title-param="<%= text_to_speech_clip.text.truncate(40) %>"
              data-audio-fetcher-author-param="<%= text_to_speech_clip.voice.name %>"
              data-audio-fetcher-filename-param="<%= "audio_#{text_to_speech_clip.id}.mp3" %>"
              data-audio-fetcher-gradient-start-param="<%= text_to_speech_clip.voice.gradient_start %>"
              data-audio-fetcher-gradient-end-param="<%= text_to_speech_clip.voice.gradient_end %>"
              data-audio-fetcher-created-at-param="<%= text_to_speech_clip.created_at.strftime('%-d/%-m/%Y') %>">

        <div data-play-icon-url>
          <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
        </div>
      </button>

      <div contents data-controller="popover" data-popover-placement-value="bottom-end">

        <button type="button" class="btn btn--icon btn--subtle" data-popover-target="trigger" popovertarget="<%= dom_id(text_to_speech_clip, "#{context}_popover") %>" aria-haspopup="true">
          <span class="icon icon--more-horizontal" aria-hidden="true"></span>
        </button>

        <div popover id="<%= dom_id(text_to_speech_clip, "#{context}_popover") %>" class="popover" style="--popover-size: 8rem;" data-popover-target="content" role="menu" aria-label="Menu">
          <div class="menu" data-controller="menu" data-action="keydown->menu#navigate">
            <%= link_to audio_url_generated_audio_clip_path(text_to_speech_clip), 
                        data: { menu_target: "item", turbo: "false" }, 
                        role: "menuitem", 
                        download: "audio_#{text_to_speech_clip.id}.mp3", 
                        class: "btn menu__item" do %>
              <span class="icon icon--download" aria-hidden="true"></span>
              Download
            <% end %>

            <%= link_to new_feedback_path(generated_audio_clip_id: text_to_speech_clip.id),
                        class: "btn menu__item",
                        data: { turbo_frame: "modal", menu_target: "item" },
                        role: "menuitem" do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              Feedback
            <% end %>

            <% trigger = button_tag type: "button", class: "btn menu__item", data: { action: "dialog#showModal", menu_target: "item" }, role: "menuitem" do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              Delete
            <% end %>

            <%= modal_dialog trigger, title: "Delete this audio clip?" do %>
              <p class="text-sm text-subtle mbe-4">This will permanently delete this audio clip. This action cannot be undone.</p>
              <div class="flex items-center justify-end gap">
                <button type="button" class="btn" data-action="click->dialog#close">Cancel</button>
                <%= link_to "Continue", 
                generated_audio_clip_path(text_to_speech_clip, context: context), 
                data: { turbo_method: :delete }, 
                class: "btn btn--negative" %>
              </div>
            <% end %>

          </div>
        </div>
        
      </div>
    </div>
  <% end %>
<% end %>