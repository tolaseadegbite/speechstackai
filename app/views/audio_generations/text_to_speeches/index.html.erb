<% title = "Text to Speech" %>
<% provide(:title, title) %>
<% content_for :page_header, title %>

<!-- 1. Realtime Listener (Crucial for updates) -->
<%= turbo_stream_from current_user, "history" %>

<div class="container mi-auto p-4" style="max-inline-size: 65rem;">
  
  <!-- Page Header -->
  <div class="text-center mbs-8 mbe-10">
    <h1 class="text-5xl font-bold">Create Engaging Audio in 6 African Languages</h1>
    <p class="mbs-3 text-lg text-subtle">Generate high-quality audio perfect for podcasts, lessons, or social media.</p>
  </div>

  <!-- Main Creation Area -->
  <div data-controller="character-counter voice-selector sample-text">
    
    <!-- THE FORM -->
    <%= form_with model: @clip, url: text_to_speeches_path, id: "tts-form", class: "creation-form mbe-10" do |f| %>
      
      <!-- Editor Card -->
      <div 
        class="rounded-2xl border" 
        onfocusin="this.style.boxShadow='0 0 0 2px green'" 
        onfocusout="this.style.boxShadow='none'"
        style="border-radius: 1rem; border: 1px solid --color-text-positive; transition: box-shadow 150ms cubic-bezier(0.4, 0, 0.2, 1); outline: none;">
        
        <!-- Large Text Area -->
        <div class="relative bg-shade bg-transparent">
          <%= f.text_area :text, 
            class: "input border-0 p-6",
            style: "outline: none; box-shadow: none;",
            rows: 8, 
            placeholder: "Start typing here or paste any text you want to turn into natural speech...",
            maxlength: 5000,
            data: { 
                character_counter_target: "input",
                sample_text_target: "input", 
                action: "input->character-counter#update input->sample-text#handleInput"
            } %>
        </div>

        <!-- Toolbar (Bottom Bar) -->
        <div class="flex items-center justify-between border-bs p-3 bg-subtle rounded-be-lg">
          
          <div class="flex flex-col gap-2">
            <!-- Character Counter -->
            <div class="text-xs pi-2">
                <span data-character-counter-target="count">0</span> / 5,000
            </div>
            
            <!-- LEFT: Voice Selector -->
            <div>
              <%= f.hidden_field :voice_id, data: { voice_selector_target: "input" } %>
              
              <%# 1. Trigger Button %>
              <% trigger = button_tag type: "button", class: "btn bg-shade rounded-2xl flex items-center gap-2", data: { action: "dialog#showModal" } do %>
                <span class="icon icon--user" aria-hidden="true"></span>
                <span data-voice-selector-target="label">
                    <%= @voices.first&.name || "Select Voice" %>
                </span>
                <span class="icon icon--chevron-down text-xs" aria-hidden="true"></span>
              <% end %>

              <%# 2. Voice Library Modal (Using Helper) %>
              <%= modal_dialog trigger, title: "Voice Library", size: "65rem", label: "Select a Voice" do %>
                <div class="overflow-y-auto p-1" style="max-height: 70vh;">
                  <%= render "audio_generations/text_to_speeches/voice_selection_grid", voices: @voices %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- RIGHT: Submit & Credits -->
          <div class="flex flex-col items-end gap-2">
            <span class="text-xs text-subtle font-semibold hidden sm:inline-block">
              <%= current_user.credits %> credits remaining
            </span>

            <div class="flex gap-2 items-center">
              <%# Reset Button (Hidden by default via controller) %>
              <button type="button" class="btn btn--main block" data-action="click->sample-text#resetForm" data-sample-text-target="resetButton" hidden> 
                <span class="icon icon--rotate-cw" aria-hidden="true"></span> 
              </button>

              <%= f.button class: "btn btn--positive flex items-center gap-2" do %>
                <span>Generate</span>
                <span class="icon icon--arrow-right" aria-hidden="true"></span>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Sample Texts -->
      <%= render "generated_audio_clips/partials/text_to_speech/sample_texts" %>

    <% end %>
  </div>

  <!-- History Feed -->
  <div id="history" class="mbs-12">
    <div class="">
      <h2 class="pbe-4 border-be text-xl font-semibold">Recent Generations</h2>
    </div>
    
    <!-- This ID matches your Model Broadcast target -->
    <div id="history_list">
      <%= render "generated_audio_clips/history_list", grouped_clips: @grouped_clips %>
    </div>

    <%= render "shared/pagination", pagy: @pagy %>
  </div>

</div>